{% extends 'base.html' %}
{% load static %}

{% block title %}Payment | {{ course.title }}{% endblock %}

{% block extra_css %}
<style>
    /* Custom styles for payment form */
    .payment-method-tab {
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .payment-method-tab.active {
        border-color: #4F46E5;
        background-color: #F5F3FF;
    }
    .payment-method-content {
        display: none;
    }
    .payment-method-content.active {
        display: block;
    }
    
    /* Stripe Elements styling */
    #payment-element {
        margin-bottom: 24px;
    }
    #payment-message {
        color: rgb(105, 115, 134);
        font-size: 16px;
        line-height: 20px;
        padding-top: 12px;
        text-align: center;
    }
    #payment-element .StripeElement {
        border-radius: 4px;
        padding: 12px;
        border: 1px solid rgba(50, 50, 93, 0.1);
        max-height: 44px;
        width: 100%;
        background: white;
        box-sizing: border-box;
    }
    
    /* Loading spinner */
    .spinner,
    .spinner:before,
    .spinner:after {
        border-radius: 50%;
    }
    .spinner {
        color: #ffffff;
        font-size: 22px;
        text-indent: -99999px;
        margin: 0px auto;
        position: relative;
        width: 20px;
        height: 20px;
        box-shadow: inset 0 0 0 2px;
        -webkit-transform: translateZ(0);
        -ms-transform: translateZ(0);
        transform: translateZ(0);
    }
    .spinner:before,
    .spinner:after {
        position: absolute;
        content: "";
    }
    .spinner:before {
        width: 10.4px;
        height: 20.4px;
        background: #5469d4;
        border-radius: 20.4px 0 0 20.4px;
        top: -0.2px;
        left: -0.2px;
        -webkit-transform-origin: 10.4px 10.2px;
        transform-origin: 10.4px 10.2px;
        -webkit-animation: loading 2s infinite ease 1.5s;
        animation: loading 2s infinite ease 1.5s;
    }
    .spinner:after {
        width: 10.4px;
        height: 10.2px;
        background: #5469d4;
        border-radius: 0 10.2px 10.2px 0;
        top: -0.1px;
        left: 10.2px;
        -webkit-transform-origin: 0px 10.2px;
        transform-origin: 0px 10.2px;
        -webkit-animation: loading 2s infinite ease;
        animation: loading 2s infinite ease;
    }
    @-webkit-keyframes loading {
        0% {
            -webkit-transform: rotate(0deg);
            transform: rotate(0deg);
        }
        100% {
            -webkit-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }
    @keyframes loading {
        0% {
            -webkit-transform: rotate(0deg);
            transform: rotate(0deg);
        }
        100% {
            -webkit-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<nav class="bg-gray-100 py-3">
    <div class="container mx-auto px-4">
        <ol class="list-none p-0 flex text-gray-600 text-sm">
            <li class="flex items-center">
                <a href="{% url 'home' %}" class="hover:text-primary transition-colors">Home</a>
                <svg class="w-3 h-3 mx-2 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>
            </li>
            <li class="flex items-center">
                <a href="{% url 'course_detail' slug=course.slug %}" class="hover:text-primary transition-colors">{{ course.title }}</a>
                <svg class="w-3 h-3 mx-2 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>
            </li>
            <li class="text-primary font-medium">Payment</li>
        </ol>
    </div>
</nav>

<div class="container mx-auto px-4 py-12">
    <div class="flex flex-wrap -mx-4">
        <!-- Course Summary -->
        <div class="w-full lg:w-4/12 px-4 mb-8 lg:mb-0">
            <div class="bg-white rounded-lg shadow-lg overflow-hidden sticky top-24">
                <div class="p-6 border-b border-gray-200">
                    <h2 class="text-xl font-bold mb-4">Order Summary</h2>
                    
                    <div class="flex items-center mb-4">
                        {% if course.image %}
                            <img src="{{ course.image.url }}" alt="{{ course.title }}" class="w-20 h-20 object-cover rounded mr-4">
                        {% else %}
                            <div class="w-20 h-20 bg-gray-200 rounded mr-4 flex items-center justify-center">
                                <i class="fas fa-book text-gray-400 text-2xl"></i>
                            </div>
                        {% endif %}
                        <div>
                            <h3 class="font-semibold">{{ course.title }}</h3>
                            <p class="text-sm text-gray-600">{{ course.lessons.count }} lessons</p>
                        </div>
                    </div>
                    
                    <div class="border-t border-gray-200 pt-4">
                        <div class="flex justify-between mb-2">
                            <span class="text-gray-600">Subtotal</span>
                            <span>{{ course.currency }} {{ subtotal }}</span>
                        </div>
                        
                        {% if discount > 0 %}
                        <div class="flex justify-between mb-2 text-green-600">
                            <span>Discount ({{ discount_obj.code }})</span>
                            <span>-{{ course.currency }} {{ discount }}</span>
                        </div>
                        {% endif %}
                        
                        <div class="flex justify-between mb-2">
                            <span class="text-gray-600">Tax (10%)</span>
                            <span>{{ course.currency }} {{ tax }}</span>
                        </div>
                        
                        <div class="flex justify-between font-bold text-lg mt-4 pt-4 border-t border-gray-200">
                            <span>Total</span>
                            <span>{{ course.currency }} {{ total }}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Discount Code Form -->
                <div class="p-6 bg-gray-50">
                    <h3 class="font-semibold mb-3">Have a discount code?</h3>
                    <div class="flex">
                        <input type="text" id="discount-code" class="flex-grow px-3 py-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-primary focus:border-primary" placeholder="Enter code">
                        <button id="apply-discount" class="px-4 py-2 bg-primary text-white rounded-r-md hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-colors" data-course-id="{{ course.id }}">Apply</button>
                    </div>
                    <div id="discount-message" class="mt-2 text-sm"></div>
                </div>
                
                <!-- Secure Payment Notice -->
                <div class="p-6 border-t border-gray-200">
                    <div class="flex items-center mb-3">
                        <i class="fas fa-shield-alt text-primary mr-2"></i>
                        <span class="font-semibold">Secure Payment</span>
                    </div>
                    <p class="text-sm text-gray-600">Your payment information is processed securely. We do not store your credit card details.</p>
                </div>
            </div>
        </div>
        
        <!-- Payment Form -->
        <div class="w-full lg:w-8/12 px-4">
            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                <div class="p-6 border-b border-gray-200">
                    <h1 class="text-2xl font-bold mb-2">Complete Your Purchase</h1>
                    <p class="text-gray-600">Choose your preferred payment method below.</p>
                </div>
                
                <!-- Payment Method Tabs -->
                <div class="p-6">
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-4 mb-6">
                        <div class="payment-method-tab active border rounded-lg p-4 text-center" data-method="card">
                            <i class="fas fa-credit-card text-2xl mb-2 text-primary"></i>
                            <p class="font-medium">Credit/Debit Card</p>
                        </div>
                        <div class="payment-method-tab border rounded-lg p-4 text-center" data-method="moncash">
                            <i class="fas fa-mobile-alt text-2xl mb-2 text-primary"></i>
                            <p class="font-medium">MonCash</p>
                        </div>
                        <div class="payment-method-tab border rounded-lg p-4 text-center" data-method="lajancash">
                            <i class="fas fa-money-bill-wave text-2xl mb-2 text-primary"></i>
                            <p class="font-medium">Lajan Cash</p>
                        </div>
                        <div class="payment-method-tab border rounded-lg p-4 text-center" data-method="bank">
                            <i class="fas fa-university text-2xl mb-2 text-primary"></i>
                            <p class="font-medium">Bank Transfer</p>
                        </div>
                        <div class="payment-method-tab border rounded-lg p-4 text-center" data-method="remittance">
                            <i class="fas fa-exchange-alt text-2xl mb-2 text-primary"></i>
                            <p class="font-medium">Remittance</p>
                        </div>
                        <div class="payment-method-tab border rounded-lg p-4 text-center" data-method="cash">
                            <i class="fas fa-hand-holding-usd text-2xl mb-2 text-primary"></i>
                            <p class="font-medium">Cash</p>
                        </div>
                    </div>
                    
                    <!-- Credit/Debit Card Payment Form -->
                    <div class="payment-method-content active" id="card-payment">
                        <form id="payment-form">
                            <div id="payment-element">
                                <!-- Stripe Elements will be inserted here -->
                            </div>
                            <button id="submit-button" class="w-full bg-primary text-white py-3 px-4 rounded-md font-medium hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-colors">
                                <div class="spinner hidden" id="spinner"></div>
                                <span id="button-text">Pay Now</span>
                            </button>
                            <div id="payment-message" class="hidden"></div>
                        </form>
                    </div>
                    
                    <!-- MonCash Payment Form -->
                    <div class="payment-method-content" id="moncash-payment">
                        <form action="{% url 'process_payment' %}" method="post">
                            {% csrf_token %}
                            <input type="hidden" name="course_id" value="{{ course.id }}">
                            <input type="hidden" name="payment_method" value="moncash">
                            
                            <div class="mb-6">
                                <label for="moncash-phone" class="block text-sm font-medium text-gray-700 mb-1">MonCash Phone Number</label>
                                <input type="tel" id="moncash-phone" name="moncash_phone" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary" placeholder="e.g. 50937000000" required>
                                <p class="mt-2 text-sm text-gray-600">Enter the phone number associated with your MonCash account.</p>
                            </div>
                            
                            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
                                <div class="flex">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-sm text-yellow-700">
                                            After submitting this form, you'll need to confirm the payment on your phone. Your enrollment will be activated after we verify your payment.
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <button type="submit" class="w-full bg-primary text-white py-3 px-4 rounded-md font-medium hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-colors">
                                Continue with MonCash
                            </button>
                        </form>
                    </div>
                    
                    <!-- Lajan Cash Payment Form -->
                    <div class="payment-method-content" id="lajancash-payment">
                        <form action="{% url 'process_payment' %}" method="post">
                            {% csrf_token %}
                            <input type="hidden" name="course_id" value="{{ course.id }}">
                            <input type="hidden" name="payment_method" value="lajancash">
                            
                            <div class="mb-6">
                                <label for="lajancash-phone" class="block text-sm font-medium text-gray-700 mb-1">Lajan Cash Phone Number</label>
                                <input type="tel" id="lajancash-phone" name="lajancash_phone" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary" placeholder="e.g. 50934000000" required>
                                <p class="mt-2 text-sm text-gray-600">Enter the phone number associated with your Lajan Cash account.</p>
                            </div>
                            
                            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
                                <div class="flex">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-sm text-yellow-700">
                                            After submitting this form, you'll need to confirm the payment on your phone. Your enrollment will be activated after we verify your payment.
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <button type="submit" class="w-full bg-primary text-white py-3 px-4 rounded-md font-medium hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-colors">
                                Continue with Lajan Cash
                            </button>
                        </form>
                    </div>
                    
                    <!-- Bank Transfer Payment Form -->
                    <div class="payment-method-content" id="bank-payment">
                        <form action="{% url 'process_payment' %}" method="post" enctype="multipart/form-data">
                            {% csrf_token %}
                            <input type="hidden" name="course_id" value="{{ course.id }}">
                            <input type="hidden" name="payment_method" value="bank">
                            
                            <div class="bg-blue-50 p-4 mb-6 rounded-md">
                                <h3 class="font-semibold text-blue-800 mb-2">Bank Transfer Information</h3>
                                <p class="text-sm text-blue-700 mb-2">Please transfer the exact amount to the following bank account:</p>
                                <ul class="text-sm text-blue-700 list-disc pl-5 mb-2">
                                    <li>Bank Name: Sogebank</li>
                                    <li>Account Name: Python Learn Haiti</li>
                                    <li>Account Number: 123456789</li>
                                    <li>Amount: {{ course.currency }} {{ total }}</li>
                                    <li>Reference: PL-{{ course.id }}-{{ request.user.id }}</li>
                                </ul>
                                <p class="text-sm text-blue-700">After making the transfer, please provide the reference number and upload your receipt below.</p>
                            </div>
                            
                            <div class="mb-6">
                                <label for="bank-reference" class="block text-sm font-medium text-gray-700 mb-1">Bank Reference Number</label>
                                <input type="text" id="bank-reference" name="bank_reference" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary" placeholder="e.g. Transaction ID or Reference Number" required>
                            </div>
                            
                            <div class="mb-6">
                                <label for="bank-receipt" class="block text-sm font-medium text-gray-700 mb-1">Upload Receipt (optional)</label>
                                <input type="file" id="bank-receipt" name="bank_receipt" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary" accept="image/*,.pdf">
                                <p class="mt-2 text-sm text-gray-600">Upload a screenshot or photo of your bank transfer receipt.</p>
                            </div>
                            
                            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
                                <div class="flex">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-sm text-yellow-700">
                                            Your enrollment will be activated after we verify your payment. This usually takes 1-2 business days.
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <button type="submit" class="w-full bg-primary text-white py-3 px-4 rounded-md font-medium hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-colors">
                                Submit Bank Transfer Information
                            </button>
                        </form>
                    </div>
                    
                    <!-- Remittance Payment Form -->
                    <div class="payment-method-content" id="remittance-payment">
                        <form action="{% url 'process_payment' %}" method="post">
                            {% csrf_token %}
                            <input type="hidden" name="course_id" value="{{ course.id }}">
                            <input type="hidden" name="payment_method" value="remittance">
                            
                            <div class="bg-blue-50 p-4 mb-6 rounded-md">
                                <h3 class="font-semibold text-blue-800 mb-2">Remittance Information</h3>
                                <p class="text-sm text-blue-700 mb-2">Please send the remittance to:</p>
                                <ul class="text-sm text-blue-700 list-disc pl-5">
                                    <li>Recipient Name: John Doe</li>
                                    <li>City: Port-au-Prince</li>
                                    <li>Country: Haiti</li>
                                </ul>
                            </div>
                            
                            <div class="mb-6">
                                <label for="remittance-service" class="block text-sm font-medium text-gray-700 mb-1">Remittance Service</label>
                                <select id="remittance-service" name="remittance_service" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary" required>
                                    <option value="">Select a service</option>
                                    <option value="western_union">Western Union</option>
                                    <option value="moneygram">MoneyGram</option>
                                    <option value="cam">CAM Transfer</option>
                                    <option value="unitransfer">Unitransfer</option>
                                </select>
                            </div>
                            
                            <div class="mb-6">
                                <label for="remittance-sender" class="block text-sm font-medium text-gray-700 mb-1">Sender's Name</label>
                                <input type="text" id="remittance-sender" name="remittance_sender" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary" required>
                            </div>
                            
                            <div class="mb-6">
                                <label for="remittance-mtcn" class="block text-sm font-medium text-gray-700 mb-1">MTCN / Reference Number</label>
                                <input type="text" id="remittance-mtcn" name="remittance_mtcn" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary" required>
                                <p class="mt-2 text-sm text-gray-600">The tracking number provided by the remittance service.</p>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4 mb-6">
                                <div>
                                    <label for="remittance-amount" class="block text-sm font-medium text-gray-700 mb-1">Amount Sent</label>
                                    <input type="number" id="remittance-amount" name="remittance_amount" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary" step="0.01" required>
                                </div>
                                
                                <div>
                                    <label for="remittance-currency" class="block text-sm font-medium text-gray-700 mb-1">Currency</label>
                                    <select id="remittance-currency" name="remittance_currency" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary" required>
                                        <option value="USD">USD</option>
                                        <option value="EUR">EUR</option>
                                        <option value="CAD">CAD</option>
                                        <option value="HTG">HTG</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
                                <div class="flex">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-sm text-yellow-700">
                                            Your enrollment will be activated after we verify your payment. This usually takes 1-2 business days.
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <button type="submit" class="w-full bg-primary text-white py-3 px-4 rounded-md font-medium hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-colors">
                                Submit Remittance Information
                            </button>
                        </form>
                    </div>
                    
                    <!-- Cash Payment Form -->
                    <div class="payment-method-content" id="cash-payment">
                        <form action="{% url 'process_payment' %}" method="post">
                            {% csrf_token %}
                            <input type="hidden" name="course_id" value="{{ course.id }}">
                            <input type="hidden" name="payment_method" value="cash">
                            
                            <div class="bg-blue-50 p-4 mb-6 rounded-md">
                                <h3 class="font-semibold text-blue-800 mb-2">Cash Payment Information</h3>
                                <p class="text-sm text-blue-700 mb-2">You can pay in cash at one of our offices:</p>
                                <ul class="text-sm text-blue-700 list-disc pl-5">
                                    <li>Port-au-Prince: 123 Main Street, Monday-Friday, 9am-5pm</li>
                                    <li>Cap-Haïtien: 456 Ocean Avenue, Monday-Friday, 9am-5pm</li>
                                    <li>Les Cayes: 789 Palm Street, Monday-Friday, 10am-4pm</li>
                                </ul>
                            </div>
                            
                            <div class="mb-6">
                                <label for="cash-location" class="block text-sm font-medium text-gray-700 mb-1">Office Location</label>
                                <select id="cash-location" name="cash_location" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary" required>
                                    <option value="">Select a location</option>
                                    <option value="port_au_prince">Port-au-Prince</option>
                                    <option value="cap_haitien">Cap-Haïtien</option>
                                    <option value="les_cayes">Les Cayes</option>
                                </select>
                            </div>
                            
                            <div class="mb-6">
                                <label for="cash-date" class="block text-sm font-medium text-gray-700 mb-1">Planned Payment Date</label>
                                <input type="date" id="cash-date" name="cash_date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary" min="{{ tomorrow_date|date:'Y-m-d' }}" required>
                                <p class="mt-2 text-sm text-gray-600">Please select the date when you plan to visit our office.</p>
                            </div>
                            
                            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
                                <div class="flex">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-sm text-yellow-700">
                                            This will reserve your spot in the course. Your enrollment will be activated after you make the payment at our office.
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <button type="submit" class="w-full bg-primary text-white py-3 px-4 rounded-md font-medium hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-colors">
                                Reserve Spot and Pay Later
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Need Help Section -->
            <div class="bg-white rounded-lg shadow-lg overflow-hidden mt-8">
                <div class="p-6">
                    <h2 class="text-xl font-bold mb-4">Need Help?</h2>
                    <p class="text-gray-600 mb-4">If you have any questions or need assistance with your payment, please don't hesitate to contact us.</p>
                    <div class="flex flex-wrap">
                        <a href="{% url 'contact' %}" class="inline-flex items-center px-4 py-2 border border-transparent text-base font-medium rounded-md text-primary bg-primary-50 hover:bg-primary-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-colors mr-4 mb-2">
                            <i class="fas fa-envelope mr-2"></i> Contact Support
                        </a>
                        <a href="tel:+50928000000" class="inline-flex items-center px-4 py-2 border border-transparent text-base font-medium rounded-md text-primary bg-primary-50 hover:bg-primary-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-colors mb-2">
                            <i class="fas fa-phone-alt mr-2"></i> Call Us
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://js.stripe.com/v3/"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Payment method tabs
        const paymentTabs = document.querySelectorAll('.payment-method-tab');
        const paymentContents = document.querySelectorAll('.payment-method-content');
        
        paymentTabs.forEach(tab => {
            tab.addEventListener('click', function() {
                // Remove active class from all tabs and contents
                paymentTabs.forEach(t => t.classList.remove('active'));
                paymentContents.forEach(c => c.classList.remove('active'));
                
                // Add active class to clicked tab
                this.classList.add('active');
                
                // Show corresponding content
                const method = this.getAttribute('data-method');
                document.getElementById(`${method}-payment`).classList.add('active');
            });
        });
        
        // Discount code application
        const applyDiscountBtn = document.getElementById('apply-discount');
        const discountCodeInput = document.getElementById('discount-code');
        const discountMessage = document.getElementById('discount-message');
        
        if (applyDiscountBtn) {
            applyDiscountBtn.addEventListener('click', function() {
                const code = discountCodeInput.value.trim();
                const courseId = this.getAttribute('data-course-id');
                
                if (!code) {
                    discountMessage.textContent = 'Please enter a discount code.';
                    discountMessage.className = 'mt-2 text-sm text-red-600';
                    return;
                }
                
                // Disable button and show loading state
                applyDiscountBtn.disabled = true;
                applyDiscountBtn.textContent = 'Applying...';
                
                // Send AJAX request
                const formData = new FormData();
                formData.append('code', code);
                formData.append('course_id', courseId);
                
                fetch('{% url "apply_discount" %}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update UI with discount
                        discountMessage.textContent = data.message;
                        discountMessage.className = 'mt-2 text-sm text-green-600';
                        
                        // Update order summary
                        const orderSummary = document.querySelector('.border-t.border-gray-200.pt-4');
                        
                        // Check if discount row already exists
                        let discountRow = orderSummary.querySelector('.text-green-600');
                        
                        if (!discountRow) {
                            // Create discount row
                            discountRow = document.createElement('div');
                            discountRow.className = 'flex justify-between mb-2 text-green-600';
                            discountRow.innerHTML = `
                                <span>Discount (${data.discount_info.code})</span>
                                <span>-{{ course.currency }} ${data.discount_amount.toFixed(2)}</span>
                            `;
                            
                            // Insert after subtotal
                            const subtotalRow = orderSummary.querySelector('.flex.justify-between.mb-2');
                            subtotalRow.insertAdjacentElement('afterend', discountRow);
                        } else {
                            // Update existing discount row
                            discountRow.innerHTML = `
                                <span>Discount (${data.discount_info.code})</span>
                                <span>-{{ course.currency }} ${data.discount_amount.toFixed(2)}</span>
                            `;
                        }
                        
                        // Update total
                        const totalRow = orderSummary.querySelector('.font-bold.text-lg');
                        totalRow.querySelector('span:last-child').textContent = `{{ course.currency }} ${data.new_total.toFixed(2)}`;
                        
                        // Reload page to ensure all calculations are correct
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    } else {
                        // Show error message
                        discountMessage.textContent = data.message;
                        discountMessage.className = 'mt-2 text-sm text-red-600';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    discountMessage.textContent = 'An error occurred. Please try again.';
                    discountMessage.className = 'mt-2 text-sm text-red-600';
                })
                .finally(() => {
                    // Re-enable button
                    applyDiscountBtn.disabled = false;
                    applyDiscountBtn.textContent = 'Apply';
                });
            });
        }
        
        // Stripe Elements integration
        const stripe = Stripe('{{ stripe_public_key }}');
        const elements = stripe.elements();
        const paymentElement = elements.create('payment');
        paymentElement.mount('#payment-element');
        
        const form = document.getElementById('payment-form');
        const submitButton = document.getElementById('submit-button');
        const spinner = document.getElementById('spinner');
        const buttonText = document.getElementById('button-text');
        const paymentMessage = document.getElementById('payment-message');
        
        let paymentIntentId = '';
        
        // Create payment intent when form loads
        createPaymentIntent();
        
        async function createPaymentIntent() {
            try {
                const response = await fetch('{% url "create_payment_intent" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        course_id: '{{ course.id }}'
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    showMessage(data.error);
                    return;
                }
                
                const { clientSecret } = data;
                
                // Store the client secret for later use
                form.dataset.secret = clientSecret;
            } catch (error) {
                showMessage('An error occurred while setting up the payment. Please try again.');
            }
        }
        
        if (form) {
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (!form.dataset.secret) {
                    showMessage('Payment setup is not complete. Please refresh the page and try again.');
                    return;
                }
                
                // Disable the submit button to prevent repeated clicks
                setLoading(true);
                
                const { error, paymentIntent } = await stripe.confirmPayment({
                    elements,
                    confirmParams: {
                        return_url: window.location.origin + '{% url "dashboard" %}',
                    },
                    redirect: 'if_required'
                });
                
                if (error) {
                    showMessage(error.message);
                    setLoading(false);
                } else if (paymentIntent && paymentIntent.status === 'succeeded') {
                    // Payment succeeded, submit the form to our server
                    const hiddenInput = document.createElement('input');
                    hiddenInput.setAttribute('type', 'hidden');
                    hiddenInput.setAttribute('name', 'payment_intent_id');
                    hiddenInput.setAttribute('value', paymentIntent.id);
                    
                    const courseIdInput = document.createElement('input');
                    courseIdInput.setAttribute('type', 'hidden');
                    courseIdInput.setAttribute('name', 'course_id');
                    courseIdInput.setAttribute('value', '{{ course.id }}');
                    
                    const paymentMethodInput = document.createElement('input');
                    paymentMethodInput.setAttribute('type', 'hidden');
                    paymentMethodInput.setAttribute('name', 'payment_method');
                    paymentMethodInput.setAttribute('value', 'card');
                    
                    const csrfInput = document.createElement('input');
                    csrfInput.setAttribute('type', 'hidden');
                    csrfInput.setAttribute('name', 'csrfmiddlewaretoken');
                    csrfInput.setAttribute('value', '{{ csrf_token }}');
                    
                    const serverForm = document.createElement('form');
                    serverForm.setAttribute('method', 'post');
                    serverForm.setAttribute('action', '{% url "process_payment" %}');
                    serverForm.appendChild(hiddenInput);
                    serverForm.appendChild(courseIdInput);
                    serverForm.appendChild(paymentMethodInput);
                    serverForm.appendChild(csrfInput);
                    
                    document.body.appendChild(serverForm);
                    serverForm.submit();
                }
            });
        }
        
        function setLoading(isLoading) {
            if (isLoading) {
                submitButton.disabled = true;
                spinner.classList.remove('hidden');
                buttonText.classList.add('hidden');
            } else {
                submitButton.disabled = false;
                spinner.classList.add('hidden');
                buttonText.classList.remove('hidden');
            }
        }
        
        function showMessage(messageText) {
            paymentMessage.textContent = messageText;
            paymentMessage.classList.remove('hidden');
            
            setTimeout(function() {
                paymentMessage.classList.add('hidden');
                paymentMessage.textContent = '';
            }, 8000);
        }
    });
</script>
{% endblock %}

